---
title: docker로 코드짠다?!
datetime: '2020-10-23T00:00:00.000+09:00'
description: vscode와 docker의 하모니
tags: ['docker', 'vscode']
---

## 이것이 무엇이오?

docker hub를 방황하던 도중 이상한걸 봤다. 뭐? docker로 환경을 만들고 그 안에서 개발을 해? 아니 대체 그게 무슨 소리요!

그리고 쭉 찾아보고 나서 오, 이거 좋은데? 라고 생각하게 되어 기록을 남겨놓는다.

## 예를 들어보자면 그놈의 node-gyp

항상 node-gyp는 골치덩이였다. 뭐 쩔 수 있나. nodejs에서 native로 만들어진 걸 쓰려면 필요하니...

그런데 저게 window 쪽에서는 nodejs 버전에 따라 visual studio 버전을 따진다느니 한다는 거다. 그래서 windows build tools 설치 시에 삽을 푸는 경우가 간혹 생긴다.

가장 쉬운 해결 방법은 모두가 똑같은 환경을 쓰면 된다. 다 똑같이 os를 사용하고 똑같이 인스톨하면 될거 아닌가?

이걸 vscode의 remote container가 해줄 수 있다.

## 맛 좀 보자

어떻게 하나?

0. 당연히 docker는 먼저 깔려있어야한다.
1. vscode `확장 ( Extensions )` 중에 `microsoft`가 만든 것들 중에 `Remote-Containers`가 있다. 그걸 설치한다.
2. vscode에서 f1을 눌러 command palette를 열고 `Remote Containers: Try a Sample...` 을 선택한다. 그리고 원하는 언어로 선택한다. ( 나는 예시를 위해 node를 골랐다. )

  ![이렇게 보인다.](/assets/20201023-xxxxxx-vscode-remote-container-via-docker/001.png)

3. 그럼 vscode가 새로 열리더니 뭔가 혼자 쿵짝쿵짝한다.

과정이 다 끝났다면 Dev container terminal을 보면 node가 실행 중임이 보인다. 뭘 했나 찾아보니 project root path에 있는 server.js가 실행되었고 내용은 /로 오면 hello world 텍스트를 반환하는 http 서버가 켜진거다. 포트는 3000이고.. 브라우저를 열어서 제대로 되는지 확인해보면 된다.

뭐가 잘 안되면 재시작해보거나 하면 된다.

![dev container의 안의 내용](/assets/20201023-xxxxxx-vscode-remote-container-via-docker/002.png)

## 오호? 나도 하나 만들어보고 싶군!

그럼 뭐 create-react-app으로 뭐 하나 만들고 그걸 devcontainer로 띄워보자.

### 어떻게 이런 짓을 벌이고 있나?

먼저 새로 띄워진 vscode를 보면 `.devcontainer` 디렉토리가 있다. 안의 내용을 보면 json 파일과 Dockerfile이 있다.

#### 먼저 Dockerfile을 보자.

```dockerfile
# See here for image contents: https://github.com/microsoft/vscode-dev-containers/tree/v0.134.0/containers/javascript-node/.devcontainer/base.Dockerfile
ARG VARIANT="14"
FROM mcr.microsoft.com/vscode/devcontainers/javascript-node:0-${VARIANT}

# [Optional] Uncomment this section to install additional OS packages.
# RUN apt-get update && export DEBIAN_FRONTEND=noninteractive \
#     && apt-get -y install --no-install-recommends <your-package-list-here>

# [Optional] Uncomment if you want to install an additional version of node using nvm
# ARG EXTRA_NODE_VERSION=10
# RUN su node -c "source /usr/local/share/nvm/nvm.sh && nvm install ${EXTRA_NODE_VERSION}"

# [Optional] Uncomment if you want to install more global node modules
# RUN sudo -u node npm install -g <your-package-list-here>
```

대충 내가 원하는 nodejs 버전을 지정할 수 있고 [https://github.com/microsoft/vscode-dev-containers/tree/v0.134.0/containers/javascript-node/.devcontainer/base.Dockerfile](https://github.com/microsoft/vscode-dev-containers/tree/v0.134.0/containers/javascript-node/.devcontainer/base.Dockerfile) 에 있는 내용을 참고하면 될 것 같다는 것을 알 수 있다.

실제로 base.Dockerfile을 보면 nodejs 배포 이미지를 사용하고 있다는 걸 볼 수 있다. 그건 ubuntu 기반 이미지이다. 그러고보면 apt-get 쓰고 있다.

뭐 대충보니 이 파일을 주물럭대면 우리가 원하는 환경을 추가로 세팅할 수 있다는 것을 알 수 있는 것이다.

#### 그 다음 json 파일을 보자.

```json
// For format details, see https://aka.ms/vscode-remote/devcontainer.json or this file's README at:
// https://github.com/microsoft/vscode-dev-containers/tree/v0.134.0/containers/javascript-node
{
	"name": "Node.js",
	"build": {
		"dockerfile": "Dockerfile",
		// Update 'VARIANT' to pick a Node version: 10, 12, 14
		"args": { "VARIANT": "12" }
	},

	// Set *default* container specific settings.json values on container create.
	"settings": {
		"terminal.integrated.shell.linux": "/bin/bash"
	},

	// Add the IDs of extensions you want installed when the container is created.
	"extensions": [
		"dbaeumer.vscode-eslint"
	],

	// Use 'forwardPorts' to make a list of ports inside the container available locally.
	"forwardPorts": [3000],

	// Specifies a command that should be run after the container has been created.
	"postCreateCommand": "yarn install",

	// Comment out the next line to run as root instead.
	"remoteUser": "node"
}
```

방금 봤던 Dockerfile을 사용하고 있으며 버전은 12를 쓴다는 것을 알 수 있다. extensions에는 우리가 주로 사용할 확장을 넣어주면 설치가 될 거 라는걸 알 수 있다. 오? 그렇다면 prettier라던가 등등등 원하는 것을 맘껏 세팅할 수 있을 것이다. forwardPorts에는 container에서 외부로 열려야할 포트 정보를 써주면 된다 라고 써져있으니 적당히 하면 될테고..

대충 알겠으니 시작해보자.

### 먼저 만들어졌건, 이제 새로 만들건 똑같이 하면 되겠네?

일단 cra로 하나 만들어서 잘 뜨는지까지 확인해보자.

```sh
$ create-react-app devcontainer_craapp --template typescript
$ cd devcontainer_craapp
$ yarn start
```

뭐 당연히 잘 뜰 것이다.

그럼 해당 디렉토리에 `.devcontainer` 디렉토리를 만들고 안에 파일을 만들어주자.

```dockerfile
# base.Dockerfile
ARG VARIANT=14
FROM mcr.microsoft.com/vscode/devcontainers/javascript-node:${VARIANT}

# Install tslint, typescript. eslint is installed by javascript image
ARG USERNAME=node
RUN apt-get update && export DEBIAN_FRONTEND=noninteractive && apt-get -y install --no-install-recommends build-essential autoconf automake gcc python
RUN sudo -u ${USERNAME} npm install -g --unsafe-perm tslint typescript eslint node-sass yarn
RUN sudo -u ${USERNAME} npm rebuild node-sass
RUN sudo -u ${USERNAME} yarn global add typescript node-sass create-react-app
```

난 nodejs 14를 쓸란다! 라고 해서 이렇게 했고... yarn을 쓸거고 나머지 등등 필요한 dependency를 추가로 깔았다.

```dockerfile
# Dockerfile
ARG VARIANT=14
FROM mcr.microsoft.com/vscode/devcontainers/typescript-node:${VARIANT}
```

이 파일은 뭐 할 게 없다. 중요한건 전부 base에 선언해놨으니..

`devcontainer.json` 파일은 다음과 같다.

```json
{
	"name": "my devcontainer cra app",
	"build": {
		"dockerfile": "Dockerfile",
		// Update 'VARIANT' to pick a Node version: 10, 12, 14
		"args": { "VARIANT": "14" }
	},

	// Set *default* container specific settings.json values on container create.
	"settings": {
		"terminal.integrated.shell.linux": "/bin/bash"
	},

	// Add the IDs of extensions you want installed when the container is created.
	"extensions": [
		"dbaeumer.vscode-eslint",
    "ms-vscode.vscode-typescript-tslint-plugin",
    "steoates.autoimport", // tsx import helper
    "coenraads.bracket-pair-colorizer-2", // highlight bracket
    "wmaurer.change-case", // change text macro
    "mikestead.dotenv", // support dotenv
    "editorconfig.editorconfig", // support editorconfig
    "mhutchie.git-graph", // show git log graphically
    "eamodio.gitlens", // git command helper
    "oderwat.indent-rainbow", // highlight indent
    "esbenp.prettier-vscode", // code formatter
    "ryu1kn.partial-diff", // text diff tool
    "syler.sass-indented", // support sass syntax
    "mike-co.import-sorter", // ts sort import
	],

	// Use 'forwardPorts' to make a list of ports inside the container available locally.
	"forwardPorts": [3000],

	// Use 'postCreateCommand' to run commands after the container is created.
	"postCreateCommand": "yarn install"

	// Uncomment to connect as a non-root user. See https://aka.ms/vscode-remote/containers/non-root.
	// "remoteUser": "node"
}
```

참고로 extension은 그저 내 취향일뿐이다. 원하는 대로 바꾸면 된다.

파일이 다 저장됬으면 해당 프로젝트 디렉토리 ( `.devcontainer` 디렉토리의 부모 디렉토리 ) 에서 vscode를 열어보자. 그럼 오른쪽 밑에 뭔가 뜬다.

![devcontainer 설정 후 vscode를 열면](/assets/20201023-xxxxxx-vscode-remote-container-via-docker/003.png)

그럼 `Reopen in container` 를 눌러주자. ~~( 사실 이건 그냥 커맨드 팔렛트에서도 찾아서 할 수 있는 내용이다. )~~

그리고 나면 아까도 볼 수 있었던 열심히 뭔가 쿵짝쿵짝하는 내용을 볼 수 있다..

![devcontainer를 생성 중인 docker](/assets/20201023-xxxxxx-vscode-remote-container-via-docker/004.png)

대충 뭐 다 끝나면 bash terminal을 열어 ~~( 이미 zsh가 적용되어 있다. )~~ yarn start를 쳐주고

![대망의 시작](/assets/20201023-xxxxxx-vscode-remote-container-via-docker/005.png)

호스트 쪽의 브라우저에서 http://localhost:3000/ 을 열면 짜잔! 하고 보인다. 혹시 의심이 간다면 소스에서 좀 고쳐보자. hmr이 동작하는 것이 보일 것이다.

필요가 없어지면 커맨드 팔레트를 열어 `Remote: Close` 해주고 docker에서 container를 지우면 된다.

## 결말

이로서 개발환경 구성 시에 난 윈도우인데? 난 맥인데? 이런 물음은 필요가 없어졌다. vscode 만세다. 개발환경을 이렇게 docker를 통해 뚝딱 만들어버린다는 것은 상당한 메리트가 있을 것이다.
